<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Image Editor Pro</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f1115; --panel:#151922; --panel-2:#1b2130; --text:#e7eaf0; --muted:#9aa4b2; --brand:#7c5cff; --accent:#00d3a7; --danger:#ff5c7a;
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0f1115,#0c0e12 60%);color:var(--text);font-family:'Cairo',system-ui,Segoe UI,Roboto,Arial,sans-serif}
    a{color:var(--brand);text-decoration:none}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .logo{display:flex;align-items:center;gap:10px}
    .logo .mark{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--brand),var(--accent));box-shadow:0 8px 24px #0008}
    .title{font-weight:800;letter-spacing:.2px}
    .bar{display:flex;gap:8px;align-items:center}
    .btn{background:var(--panel);border:1px solid #232a3b;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;transition:.2s;display:inline-flex;align-items:center;gap:8px}
    .btn:hover{transform:translateY(-1px);background:var(--panel-2)}
    .btn.primary{background:linear-gradient(135deg,var(--brand),#4a2cff);border:none}
    .btn.ghost{background:transparent;border:1px dashed #2a344a;color:var(--muted)}
    .grid{display:grid;grid-template-columns:360px 1fr;gap:16px}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .card{background:var(--panel);border:1px solid #1b2232;border-radius:var(--radius);box-shadow:0 10px 30px #0006}
    .panel{padding:14px}
    .panel h3{margin:4px 0 12px;font-size:18px}
    .muted{color:var(--muted);font-size:13px}
    .drop{border:2px dashed #2a344a;border-radius:var(--radius);padding:18px;text-align:center;transition:.2s;background:repeating-linear-gradient(45deg, #121620, #121620 10px, #131927 10px, #131927 20px)}
    .drop.drag{border-color:var(--brand);background:#121529}

    .workspace{display:grid;grid-template-rows:auto 1fr auto;min-height:70vh}
    .canvas-wrap{position:relative;display:grid;place-items:center;background:#0c0f16;border-radius:var(--radius);border:1px solid #1a2030;overflow:hidden}
    canvas{max-width:100%;height:auto;border-radius:12px}
    .overlay-text{position:absolute;inset:0;display:grid;place-items:center;color:#94a0b4}

    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between;padding:10px;background:var(--panel-2);border-radius:var(--radius);border:1px solid #1a2030}

    .controls{display:flex;flex-direction:column;gap:10px}
    .control{background:var(--panel-2);padding:10px;border-radius:12px;border:1px solid #1a2030}
    .control .row{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px}
    .control label{font-size:14px}
    .control input[type="range"]{width:100%}

    .presets{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .preset{cursor:pointer;border-radius:12px;overflow:hidden;border:1px solid #20283b;background:#0c1020;transition:.2s}
    .preset:hover{transform:translateY(-1px)}
    .preset img{width:100%;display:block;aspect-ratio:16/9;object-fit:cover;filter:contrast(1.1)}
    .preset span{display:block;padding:8px 10px;font-size:13px;color:#bcc5d6}

    .footer{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-top:12px}
    .notice{font-size:12px;color:#8b95a7}
    .switch{display:flex;align-items:center;gap:8px}
    .switch input{width:42px;height:22px;appearance:none;background:#323b52;border-radius:999px;position:relative;outline:none;cursor:pointer;transition:.2s}
    .switch input:checked{background:#3a8b7f}
    .switch input::after{content:"";position:absolute;top:3px;right:3px;width:16px;height:16px;background:#fff;border-radius:50%;transition:.2s}
    .switch input:checked::after{right:23px}

    .quality{display:flex;align-items:center;gap:10px}
    select, input[type="number"]{background:#121623;border:1px solid #20283b;color:var(--text);padding:8px 10px;border-radius:10px}

    .kbd{font-family:monospace;background:#0e1320;border:1px solid #222a3f;border-radius:6px;padding:2px 6px;color:#9fb2d5}

    /* Modal simple styles */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:9999}
    .modal-card{background:#0f1724;border-radius:14px;padding:20px;max-width:520px;width:92%;color:var(--text);box-shadow:0 10px 40px #000}
    .modal-card h2{margin:0 0 10px;font-size:20px}
    .modal-card p{margin:0 0 16px;color:var(--muted);line-height:1.4}
    .modal-actions{display:flex;gap:10px;justify-content:center}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111827;padding:8px 14px;border-radius:10px;color:#d1d5db;box-shadow:0 6px 20px #000;display:none;z-index:10000}
    .toast.show{display:block}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <div class="mark"></div>
        <div>
          <div class="title">Image Editor Pro</div>
          <div class="muted">Ù…Ø­Ø±Ù‘Ø± ØµÙˆØ± Ø³Ø±ÙŠØ¹ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØµÙÙ‘Ø­ â€“ Ø¨Ø¯ÙˆÙ† Ø±ÙØ¹ Ù…Ù„ÙØ§Øª (Ø¥Ù„Ø§ Ø¨Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©)</div>
        </div>
      </div>
      <div class="bar">
        <label class="btn">
          ğŸ“¤ Ø§Ø®ØªØ± ØµÙˆØ±Ø©
          <input id="fileInput" type="file" accept="image/*" hidden>
        </label>
        <button id="downloadBtn" class="btn primary">ğŸ’¾ ØªÙ†Ø²ÙŠÙ„</button>
        <button id="resetBtn" class="btn">â†º Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·</button>
      </div>
    </header>

    <div class="grid">
      <!-- Sidebar -->
      <aside class="card panel">
        <h3>Ø­Ù…Ù‘Ù„ ØµÙˆØ±Ø©</h3>
        <div id="drop" class="drop">Ø§Ø³Ø­Ø¨ ÙˆØ£ÙÙ„Øª ØµÙˆØ±Ø© Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± "Ø§Ø®ØªØ± ØµÙˆØ±Ø©" Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰</div>
        <p class="muted" style="margin-top:10px">ÙƒÙ„ Ø´ÙŠØ¡ ÙŠØªÙ… Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… <span class="kbd">Canvas</span>.<br>Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ± Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙŠØªÙ… ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„ØµØ±ÙŠØ­Ø©.</p>

        <!-- ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„ÙˆØ§Ø¶Ø­ -->
        <div style="margin-top:12px">
          <label style="display:flex;gap:10px;align-items:center;cursor:pointer">
            <input id="consentCheckbox" type="checkbox" />
            <span class="muted">Ø£ÙˆØ§ÙÙ‚ ØµØ±Ø§Ø­Ø©Ù‹ Ø¹Ù„Ù‰ Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±ØªÙŠ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠØ© (Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„Ø£Ù…Ø§Ù†).</span>
          </label>
        </div>

        <h3 style="margin-top:18px">Ø§Ù„ØªØ­ÙƒÙ‘Ù… Ø§Ù„ÙŠØ¯ÙˆÙŠ</h3>
        <div class="controls">
          <!-- sliders Ù‡Ù†Ø§ ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚ -->
          <div class="control">
            <div class="row"><label>Ø§Ù„Ø³Ø·ÙˆØ¹ <span id="val-brightness" class="muted"></span></label><button data-reset="brightness" class="btn ghost">Ø¥Ø±Ø¬Ø§Ø¹</button></div>
            <input type="range" id="brightness" min="0" max="200" value="100">
          </div>
          <!-- Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙ†ØªØ±ÙˆÙ„Ø²... (Ù„Ù…Ù‚Ø§Ù„Ø© Ø§Ù„Ø¥Ø®ØªØµØ§Ø± Ù†ÙØ³ Ø¹Ù†Ø§ØµØ±Ùƒ Ø§Ù„Ø£ØµÙ„ÙŠØ©) -->
          <div class="control">
            <div class="row"><label>Ø§Ù„ØªØ¨Ø§ÙŠÙ† <span id="val-contrast" class="muted"></span></label><button data-reset="contrast" class="btn ghost">Ø¥Ø±Ø¬Ø§Ø¹</button></div>
            <input type="range" id="contrast" min="0" max="200" value="100">
          </div>
          <div class="control">
            <div class="row"><label>Ø§Ù„ØªØ´Ø¨Ù‘Ø¹ <span id="val-saturate" class="muted"></span></label><button data-reset="saturate" class="btn ghost">Ø¥Ø±Ø¬Ø§Ø¹</button></div>
            <input type="range" id="saturate" min="0" max="200" value="100">
          </div>
          <div class="control">
            <div class="row"><label>ØªÙ„ÙˆÙŠÙ† (Hue) <span id="val-hue" class="muted"></span></label><button data-reset="hue" class="btn ghost">Ø¥Ø±Ø¬Ø§Ø¹</button></div>
            <input type="range" id="hue" min="-180" max="180" value="0">
          </div>
          <div class="control">
            <div class="row"><label>Ø§Ù„Ø¥Ø¹ØªØ§Ù… (Gamma) <span id="val-gamma" class="muted"></span></label><button data-reset="gamma" class="btn ghost">Ø¥Ø±Ø¬Ø§Ø¹</button></div>
            <input type="range" id="gamma" min="50" max="250" value="100">
          </div>
          <div class="control">
            <div class="row"><label>ØªÙ…ÙˆÙŠÙ‡ (Blur) <span id="val-blur" class="muted"></span></label><button data-reset="blur" class="btn ghost">Ø¥Ø±Ø¬Ø§Ø¹</button></div>
            <input type="range" id="blur" min="0" max="10" value="0">
          </div>
          <div class="control">
            <div class="row"><label>ØªØ£Ø«ÙŠØ± Ù‚Ø¯ÙŠÙ… (Sepia) <span id="val-sepia" class="muted"></span></label><button data-reset="sepia" class="btn ghost">Ø¥Ø±Ø¬Ø§Ø¹</button></div>
            <input type="range" id="sepia" min="0" max="100" value="0">
          </div>
          <div class="control">
            <div class="row"><label>Ø£Ø¨ÙŠØ¶ ÙˆØ£Ø³ÙˆØ¯ (Grayscale) <span id="val-gray" class="muted"></span></label><button data-reset="grayscale" class="btn ghost">Ø¥Ø±Ø¬Ø§Ø¹</button></div>
            <input type="range" id="grayscale" min="0" max="100" value="0">
          </div>
        </div>

        <h3 style="margin-top:18px">ÙÙ„Ø§ØªØ± Ø¬Ø§Ù‡Ø²Ø©</h3>
        <div class="presets" id="presets"></div>
      </aside>

      <!-- Workspace -->
      <section class="workspace">
        <div class="toolbar">
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="rotateLeft" class="btn">â†¶ ØªØ¯ÙˆÙŠØ±</button>
            <button id="rotateRight" class="btn">â†· ØªØ¯ÙˆÙŠØ±</button>
            <button id="flipH" class="btn">â‡‹ Ø¹ÙƒØ³ Ø£ÙÙ‚ÙŠ</button>
            <button id="flipV" class="btn">â‡µ Ø¹ÙƒØ³ Ø±Ø£Ø³ÙŠ</button>
            <button id="undoBtn" class="btn">â¤º ØªØ±Ø§Ø¬Ø¹</button>
            <button id="redoBtn" class="btn">â¤» Ø¥Ø¹Ø§Ø¯Ø©</button>
            <label class="switch">
              <span class="muted">Ù…Ù‚Ø§Ø±Ù†Ø© Ù‚Ø¨Ù„/Ø¨Ø¹Ø¯</span>
              <input type="checkbox" id="compareToggle">
            </label>
          </div>
          <div class="quality">
            <label class="muted">Ø§Ù„ØµÙŠØºØ©</label>
            <select id="format">
              <option value="image/jpeg">JPG</option>
              <option value="image/png">PNG</option>
              <option value="image/webp">WebP</option>
            </select>
            <label class="muted">Ø§Ù„Ø¬ÙˆØ¯Ø©</label>
            <input id="quality" type="number" min="0.1" max="1" step="0.1" value="0.9" />
            <small class="muted">Ø§Ø®ØªØµØ§Ø±: <span class="kbd">Ctrl/Cmd + S</span></small>
          </div>
        </div>

        <div class="canvas-wrap card" id="stage">
          <canvas id="canvas" width="1280" height="720"></canvas>
          <div class="overlay-text" id="placeholder">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© â€“ Ø§Ø±ÙØ¹ ØµÙˆØ±Ø© Ù„Ù„Ø¨Ø¯Ø¡</div>
        </div>

        <div class="footer">
          <div class="notice">Ù†ØµÙŠØ­Ø©: Ø§Ø³Ø­Ø¨ Ù…Ø¤Ø´Ø± Ø§Ù„ÙØ£Ø±Ø© ÙÙˆÙ‚ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙ„Ø§ØªØ± Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø³Ø±ÙŠØ¹Ø© Ù‚Ø¨Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.</div>
          <div>
            <span class="muted">Â© 2025 â€“ Ù…Ø­Ø±Ø± ØµÙˆØ± Ù…ØªÙ‚Ø¯Ù‘Ù… ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªØµÙØ­ ÙÙ‚Ø·.</span>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Modal: ØªØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø£ÙˆÙ„ Ø²ÙŠØ§Ø±Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© -->
  <div id="consentModal" class="modal-backdrop" style="display:none">
    <div class="modal-card">
      <h2>ØªÙ†Ø¨ÙŠÙ‡ Ù…Ù‡Ù… â€” Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h2>
      <p>Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠÙ‚ÙˆÙ… Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØµÙˆØ± Ø§Ù„ØªÙŠ ÙŠØªÙ… Ø±ÙØ¹Ù‡Ø§ Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠØ©. Ù„Ø§ ØªÙ‚Ù… Ø¨Ø±ÙØ¹ Ø£ÙŠ ØµÙˆØ± Ù…Ø®Ù„Ø© Ø£Ùˆ Ù…Ø®Ø§Ù„ÙØ©. Ø¨Ø§Ù„Ø¥Ø¶Ø±Ø§Ø± Ø¨Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù‚Ø¯ ÙŠØªÙ… Ø­Ø¸Ø± Ø§Ù„Ø­Ø³Ø§Ø¨ Ø£Ùˆ Ø­Ø°Ù Ø§Ù„Ù…Ø­ØªÙˆÙ‰.</p>
      <div class="modal-actions">
        <button id="modalDecline" class="btn">Ù„Ø§ Ø£ÙˆØ§ÙÙ‚</button>
        <button id="modalAgree" class="btn primary">Ù…ÙˆØ§ÙÙ‚ ÙˆØ£ÙÙ‡Ù…</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Ø§Ø­ØªÙØ¸ Ø¨Ù†ÙØ³ Ø±Ø£Ø³ Ø§Ù„Ù…Ù„Ù ÙˆCSS â€” Ø³Ø£Ø¹Ø±Ø¶ Ù‡Ù†Ø§ Ù‚Ø³Ù… Ø§Ù„Ù€ <script> Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ (Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¨Ø§Ù„Ø¢ØªÙŠ) -->
<script>
  // ===== Utilities =====
  const $ = (s, p=document)=>p.querySelector(s);
  const $$ = (s, p=document)=>Array.from(p.querySelectorAll(s));

  const fileInput = $('#fileInput');
  const drop = $('#drop');
  const canvas = $('#canvas');
  const ctx = canvas.getContext('2d');
  const placeholder = $('#placeholder');
  const consentCheckbox = $('#consentCheckbox');
  const toastEl = $('#toast');

  const consentModal = $('#consentModal');
  const modalAgree = $('#modalAgree');
  const modalDecline = $('#modalDecline');

  function showToast(text, ms=3000){
    toastEl.textContent = text; toastEl.classList.add('show');
    setTimeout(()=> toastEl.classList.remove('show'), ms);
  }

  // consent in localStorage
  const CONSENT_KEY = 'image_editor_consent_v1';
  function getConsent() { return localStorage.getItem(CONSENT_KEY) === 'true'; }
  function setConsent(v){
    localStorage.setItem(CONSENT_KEY, v ? 'true' : 'false');
    consentCheckbox.checked = !!v;
  }

  window.addEventListener('load', ()=>{
    const consent = getConsent();
    consentCheckbox.checked = consent;
    if(!consent){
      consentModal.style.display = 'flex';
    }
  });

  modalAgree.addEventListener('click', ()=>{
    setConsent(true);
    consentModal.style.display = 'none';
    showToast('Ø´ÙƒØ±Ù‹Ø§. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ù…Ø±Ø¦ÙŠØ© Ù…Ø­ÙÙˆØ¸Ø©.');
  });
  modalDecline.addEventListener('click', ()=>{
    setConsent(false);
    consentModal.style.display = 'none';
    showToast('ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¯ÙˆÙ† Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ± Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©.');
  });
  consentCheckbox.addEventListener('change', ()=> setConsent(consentCheckbox.checked) );

  // ===== state & helpers =====
  const state = {
    img: null, history: [], future: [],
    angle:0, flipH:false, flipV:false,
    controls: { brightness:100, contrast:100, saturate:100, hue:0, gamma:100, blur:0, sepia:0, grayscale:0 },
    comparing:false, lastExportURL:null
  };

  function setPlaceholder(show){ placeholder.style.display = show ? 'grid' : 'none'; }
  function pushHistory(){
    try{
      state.history.push(canvas.toDataURL('image/png'));
      if(state.history.length>40) state.history.shift();
      state.future=[];
    }catch(e){ console.warn('pushHistory error', e); }
  }
  function loadDataURL(dataURL){ return new Promise((resolve,reject)=>{ const img=new Image(); img.onload=()=>resolve(img); img.onerror=reject; img.src=dataURL; }); }

  // ===== improved drawImageFit (handles rotation 90/270 & flipping correctly) =====
  function drawImageFit(img){
    if(!img) return;
    const maxW = Math.min(1600, window.innerWidth*0.9);
    // choose base width (no rotation)
    const baseWidth = Math.min(img.width, maxW);
    const baseHeight = Math.round(baseWidth / (img.width / img.height));
    canvas.width = Math.round(baseWidth);
    canvas.height = Math.round(baseHeight);

    ctx.save();
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // normalized angle (0..359)
    const angleNorm = ((state.angle % 360) + 360) % 360;
    const angleRad = angleNorm * Math.PI / 180;
    const rotated = angleNorm === 90 || angleNorm === 270;

    // compute scale depending on rotation
    const scale = rotated
      ? Math.min(canvas.width / img.height, canvas.height / img.width)
      : Math.min(canvas.width / img.width, canvas.height / img.height);

    const drawW = img.width * scale;
    const drawH = img.height * scale;

    // draw centered with transforms
    ctx.translate(canvas.width/2, canvas.height/2);
    ctx.scale(state.flipH ? -1 : 1, state.flipV ? -1 : 1);
    ctx.rotate(angleRad);
    ctx.drawImage(img, -drawW/2, -drawH/2, drawW, drawH);
    ctx.restore();

    applyFiltersToCanvas();
  }

  async function openFile(file){
    if(!file) return;
    const reader = new FileReader();
    reader.onload = async (e)=>{
      try{
        const img = await loadDataURL(e.target.result);
        state.img = img; state.angle=0; state.flipH=false; state.flipV=false; state.future=[]; state.history=[];
        drawImageFit(img); setPlaceholder(false); pushHistory();
        // Ø¨Ø¹Ø¯ ÙØªØ­ Ø§Ù„ØµÙˆØ±Ø©: Ø­Ø§ÙˆÙ„ Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© **ÙÙ‚Ø·** Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§ÙÙ‚ ØµØ±Ø§Ø­Ø© (localStorage)
        maybeSendToServerIfConsented(file.name || 'uploaded.jpg');
      }catch(err){
        console.error('openFile error', err);
        showToast('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©.');
      }
    };
    reader.readAsDataURL(file);
  }

  // Drag & Drop
  drop.addEventListener('dragover', (e)=>{e.preventDefault(); drop.classList.add('drag');});
  drop.addEventListener('dragleave', ()=> drop.classList.remove('drag'));
  drop.addEventListener('drop', (e)=>{ e.preventDefault(); drop.classList.remove('drag'); const file = e.dataTransfer.files?.[0]; openFile(file); });

  fileInput.addEventListener('change', (e)=>{ const file = e.target.files?.[0]; openFile(file); });

  // ===== sliders setup (live preview on input; push history on change only) =====
  const sliders = {
    brightness: $('#brightness'),
    contrast: $('#contrast'),
    saturate: $('#saturate'),
    hue: $('#hue'),
    gamma: $('#gamma'),
    blur: $('#blur'),
    sepia: $('#sepia'),
    grayscale: $('#grayscale'),
  };
  const valueSpans = {
    brightness: $('#val-brightness'),
    contrast: $('#val-contrast'),
    saturate: $('#val-saturate'),
    hue: $('#val-hue'),
    gamma: $('#val-gamma'),
    blur: $('#val-blur'),
    sepia: $('#val-sepia'),
    grayscale: $('#val-gray'),
  };

  function updateValueLabels(){
    valueSpans.brightness.textContent = sliders.brightness.value + '%';
    valueSpans.contrast.textContent = sliders.contrast.value + '%';
    valueSpans.saturate.textContent = sliders.saturate.value + '%';
    valueSpans.hue.textContent = sliders.hue.value + 'Â°';
    valueSpans.gamma.textContent = (sliders.gamma.value/100).toFixed(2)+'Ã—';
    valueSpans.blur.textContent = sliders.blur.value + 'px';
    valueSpans.sepia.textContent = sliders.sepia.value + '%';
    valueSpans.grayscale.textContent = sliders.grayscale.value + '%';
  }

  // ensure blur can be fractional (set step in HTML), gamma is handled as multiplier
  function buildFilterString(){ const c = state.controls; return `brightness(${c.brightness}%) contrast(${c.contrast}%) saturate(${c.saturate}%) hue-rotate(${c.hue}deg) sepia(${c.sepia}%) grayscale(${c.grayscale}%) blur(${c.blur}px)`; }

  function applyFiltersToCanvas(){
    if(!canvas) return;
    const off = document.createElement('canvas'); off.width=canvas.width; off.height=canvas.height;
    const octx = off.getContext('2d');
    octx.filter = buildFilterString();
    // draw current canvas into offscreen with filters (works for previews)
    octx.drawImage(canvas,0,0,off.width,off.height);
    const filtered = octx.getImageData(0,0,off.width,off.height);
    const gamma = Math.max(0.01, state.controls.gamma/100);
    const f = filtered.data;
    for(let i=0;i<f.length;i+=4){
      f[i] = 255 * Math.pow(f[i]/255, 1/gamma);
      f[i+1] = 255 * Math.pow(f[i+1]/255, 1/gamma);
      f[i+2] = 255 * Math.pow(f[i+2]/255, 1/gamma);
    }
    ctx.putImageData(filtered,0,0);
  }

  // input = live preview; change = store history (to avoid floods)
  Object.entries(sliders).forEach(([key, el])=>{
    // ensure some sliders have better step (set in HTML markup for blur etc.)
    el.addEventListener('input', ()=>{
      state.controls[key] = Number(el.value);
      updateValueLabels();
      if(state.img){ drawImageFit(state.img); } // live preview
    });
    el.addEventListener('change', ()=>{ // finalize and push history
      state.controls[key] = Number(el.value);
      if(state.img){ drawImageFit(state.img); pushHistory(); }
    });
  });
  updateValueLabels();

  // ===== presets =====
  const PRESETS = [
    {name:'Boost', values:{brightness:110, contrast:115, saturate:120, hue:0, gamma:110, blur:0, sepia:0, grayscale:0}},
    {name:'Cinematic', values:{brightness:102, contrast:120, saturate:110, hue:8, gamma:115, blur:0.2, sepia:10, grayscale:0}},
    {name:'Noir', values:{brightness:95, contrast:130, saturate:0, hue:0, gamma:120, blur:0, sepia:0, grayscale:100}},
    {name:'Vintage', values:{brightness:105, contrast:105, saturate:110, hue:-5, gamma:100, blur:0, sepia:35, grayscale:0}},
    {name:'Creamy', values:{brightness:112, contrast:95, saturate:105, hue:0, gamma:105, blur:0, sepia:10, grayscale:0}},
    {name:'Cool Blue', values:{brightness:100, contrast:110, saturate:105, hue:-18, gamma:110, blur:0, sepia:0, grayscale:0}},
  ];
  function renderPresets(){
    const wrap = $('#presets'); wrap.innerHTML='';
    PRESETS.forEach((p,idx)=>{
      const card=document.createElement('div'); card.className='preset'; card.title=p.name;
      const thumb=document.createElement('img');
      const prev=document.createElement('canvas'); prev.width=160; prev.height=90; const pctx=prev.getContext('2d');
      if(state.img){ pctx.drawImage(state.img,0,0,prev.width,prev.height); } else { pctx.fillStyle='#111826'; pctx.fillRect(0,0,prev.width,prev.height); pctx.fillStyle='#2e3a52'; pctx.fillRect(30,25,100,40); }
      thumb.src = prev.toDataURL('image/jpeg',.7);
      thumb.style.filter = `brightness(${p.values.brightness}%) contrast(${p.values.contrast}%) saturate(${p.values.saturate}%) hue-rotate(${p.values.hue}deg) sepia(${p.values.sepia}%) grayscale(${p.values.grayscale}%) blur(${p.values.blur}px)`;
      const label=document.createElement('span'); label.textContent = p.name;
      card.appendChild(thumb); card.appendChild(label);
      card.addEventListener('mouseenter',()=>{ // preview on hover without mutating history
        const prevVals = {...state.controls};
        state.controls = {...p.values};
        if(state.img) drawImageFit(state.img);
        state.controls = prevVals;
      });
      card.addEventListener('mouseleave',()=> state.img && drawImageFit(state.img));
      card.addEventListener('click',()=>{
        Object.keys(sliders).forEach(k=>{
          if(p.values[k] !== undefined){
            sliders[k].value = p.values[k];
            state.controls[k] = p.values[k];
          }
        });
        updateValueLabels();
        if(state.img){ drawImageFit(state.img); pushHistory(); }
      });
      wrap.appendChild(card);
    });
  }
  renderPresets();

  // ===== transforms, undo/redo, compare, export... =====
  function applyTransform(type){ if(!state.img) return; if(type==='rotL') state.angle = (state.angle - 90) % 360; if(type==='rotR') state.angle = (state.angle + 90) % 360; if(type==='flipH') state.flipH = !state.flipH; if(type==='flipV') state.flipV = !state.flipV; drawImageFit(state.img); pushHistory(); }
  $('#rotateLeft').onclick = ()=> applyTransform('rotL');
  $('#rotateRight').onclick = ()=> applyTransform('rotR');
  $('#flipH').onclick = ()=> applyTransform('flipH');
  $('#flipV').onclick = ()=> applyTransform('flipV');

  $('#undoBtn').onclick = async ()=>{
    if(state.history.length>1){
      const current = state.history.pop();
      state.future.push(current);
      const prev = state.history[state.history.length-1];
      const img = await loadDataURL(prev);
      state.img = img;
      drawImageFit(img);
    }
  };
  $('#redoBtn').onclick = async ()=>{
    if(state.future.length){
      const next = state.future.pop();
      state.history.push(next);
      const img = await loadDataURL(next);
      state.img = img;
      drawImageFit(img);
    }
  };

  const compareToggle = $('#compareToggle');
  compareToggle.addEventListener('change',()=>{
    state.comparing = compareToggle.checked;
    if(!state.img) return;
    if(state.comparing){
      // show original (unfiltered/untransformed) â€” if you want transformed original, adjust here
      ctx.save();
      ctx.clearRect(0,0,canvas.width,canvas.height);
      // draw original fit without filters
      const temp = new Image();
      temp.onload = ()=>{ ctx.drawImage(temp,0,0,canvas.width,canvas.height); ctx.restore(); };
      // create a data url of original image fitted (quick approach)
      const tmpCanvas = document.createElement('canvas');
      tmpCanvas.width = canvas.width; tmpCanvas.height = canvas.height;
      const tctx = tmpCanvas.getContext('2d');
      tctx.drawImage(state.img, 0, 0, tmpCanvas.width, tmpCanvas.height);
      temp.src = tmpCanvas.toDataURL();
    }else{
      drawImageFit(state.img);
    }
  });

  function download(filename, url){ const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); }
  function exportImage(){
    if(!state.img){ alert('Ø£Ø¶Ù ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹'); return; }
    const type = $('#format').value;
    let q = parseFloat($('#quality').value || '0.9');
    q = Math.min(1, Math.max(0.1, q));
    drawImageFit(state.img);
    const dataURL = canvas.toDataURL(type, q);
    state.lastExportURL = dataURL;
    const ext = type.includes('png')?'png': type.includes('webp')?'webp':'jpg';
    download('edited.'+ext, dataURL);
  }
  $('#downloadBtn').onclick = exportImage;
  document.addEventListener('keydown',(e)=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); exportImage(); } });

  $('#resetBtn').onclick = ()=>{
    const defaults = {brightness:100,contrast:100,saturate:100,hue:0,gamma:100,blur:0,sepia:0,grayscale:0};
    Object.entries(sliders).forEach(([k,el])=>{ el.value = defaults[k]; state.controls[k]=Number(el.value); });
    state.angle=0; state.flipH=false; state.flipV=false; updateValueLabels();
    if(state.img){ drawImageFit(state.img); pushHistory(); }
  };

  document.addEventListener('paste', async (e)=>{
    const item = [...(e.clipboardData?.items||[])].find(i=> i.type?.startsWith && i.type.startsWith('image/'));
    if(item){ const file = item.getAsFile(); openFile(file); }
  });

  setPlaceholder(true);

  // ======= send to server only if consented =======
  async function maybeSendToServerIfConsented(filename){
    if(!getConsent()) {
      console.log('Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø©: Ù„Ù… ØªÙØ¹Ø·Ù Ù…ÙˆØ§ÙÙ‚Ø© ØµØ±ÙŠØ­Ø©.');
      return;
    }
    if(!state.img) return;
    try {
      // apply filters before export
      drawImageFit(state.img);
      const dataURL = canvas.toDataURL('image/jpeg', 0.9);
      // basic size check on client (avoid oversized uploads)
      const sizeInKB = (dataURL.length * (3/4)) / 1024;
      if(sizeInKB > 12000){ // ~12MB
        showToast('Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ù‹Ø§ Ù„Ù„Ø¥Ø±Ø³Ø§Ù„. Ù‚Ù„Ù„ Ø§Ù„Ø¬ÙˆØ¯Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.');
        return;
      }
      const payload = { filename: filename || 'uploaded.jpg', image: dataURL, consent: true, timestamp: new Date().toISOString() };
      const res = await fetch('/api/upload', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const j = await res.json();
      if(res.ok && j.ok){
        showToast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨Ù†Ø¬Ø§Ø­.');
      } else {
        showToast('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©.');
        console.error('send failed', j);
      }
    } catch (err){
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:', err);
      showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.');
    }
  }

  // ====== end client ======
</script>

</body>
</html>
